<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PDF Viewer</title>

<style>
body { margin:0; background:#111; }
#pdf { position:relative; }
canvas { display:block; margin:10px auto; }

.watermark {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) rotate(-30deg);
  font-size:48px;
  color:rgba(0,255,0,0.15);
  pointer-events:none;
  user-select:none;
}
</style>
</head>

<body>

<div id="pdf"></div>
<div class="watermark">URJA ARTS</div>

<script type="module">
import * as pdfjsLib from './pdfjs/pdf.mjs';

pdfjsLib.GlobalWorkerOptions.workerSrc =
  './pdfjs/pdf.worker.mjs';

const url = new URLSearchParams(location.search).get('file');
const container = document.getElementById('pdf');

let pdfDoc = null;

async function renderPage(pageNum) {
  const page = await pdfDoc.getPage(pageNum);

  const unscaled = page.getViewport({ scale: 1 });

  const maxWidth = Math.min(window.innerWidth - 20, 900);
  const scale = Math.min(maxWidth / unscaled.width, 2); // ⛔ SCALE CAP

  const viewport = page.getViewport({ scale });

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  canvas.width = viewport.width;
  canvas.height = viewport.height;

  container.appendChild(canvas);

  await page.render({
    canvasContext: ctx,
    viewport: viewport
  }).promise;
}

async function renderAllPages() {
  container.innerHTML = '';

  for (let i = 1; i <= pdfDoc.numPages; i++) {
    await renderPage(i); // ⬅ sequential render (memory safe)
  }
}

(async function () {
  try {
    pdfDoc = await pdfjsLib.getDocument({ url }).promise;
    renderAllPages();
  } catch (e) {
    container.innerHTML =
      '<p style="color:white;text-align:center">Unable to load PDF</p>';
    console.error(e);
  }
})();

</script>
</body>
</html>
